# Uniswap V3 Concentrated Liquidity

## uniswap V2 的问题

在 uniswap V2 中，流动性是按照 $x \cdot y = k$ 曲线，在整个价格区间 $(0,\infty)$ 上均匀分布的，也就是池子流动性允许以任何价格进行交易。

但是资产的历史价格会保持在一个确定的范围内，无论这个范围是宽还是窄，例如，ETH 的价格历史价格范围是 0.75 到 4800，USDC 的始终维系在 1 附近。没有人会以 5000 的价格购买一个 ETH。因此在远离当前价格或永远无法到达的价格区间提供流动性毫无意义，下面我们用数学模型来更直观的看看这会导致什么问题？

假设 ETH/USDT 交易对的现货价格为 1500 USDT/ETH，流动性池子中共有资金 4500USDT 和 3ETH。

用 x 表示 USDT，y 表示 ETH，$x_1$ = 4500, $y_1$ = 3, k = 13500

**如果价格下跌至 1300 USDT/ETH**, 此时则有：

$$
x_2 \cdot y_2 = 13500
$$

$$
\frac{x_2}{y_2} = 1300
$$

得: x_2 = 4192.54, y_2 = 3.22，也就是说在 1500 到 1300 这个价格区间，只有 $4500 - 4192.54 = 307.46$ USDT 在支撑流动性，资金利用率只有 $\frac{307.46}{4500} = 6.84\%$

**如果价格上涨至 1700USDT/ETH**, 此时则有：

$$
x_3 \cdot y_3 = 13500
$$

$$
\frac{x_3}{y_3} = 1700
$$

得：x_3 = 4789, y_3 = 2.817, 也就是说在 1500 到 1700 这个价格区间，只有 $3 - 2.817 = 0.183$ ETH 在支撑流动性，资金利用率只有 $\frac{0.183}{3} = 6.1\%$

从上面的例子中我们可以看出，假设 ETH 的价格在某一段时间内一直在 1300 - 1700 这个区间波动，而流动性被稀释到 $(0,\infty)$ 这个区间，资金利用率非常低，这会导致

- LP 的资金无法被充分利用，大部分流动性在支持无意义的价格区间，躺着发霉，LP 的收益降低
- 在一个 trader 频繁交易的价格区间内，流动性无法被充分利用，增大大额交易的 price impact。

而这个缺点在 USDT/DAT 这类稳定币交易对中会被放大，因为稳定币始终维持的 1 附近，价格区间非常小，资金利用率会进一步降低。为了解决这个问题，uniswap V3 引入了集中流动性。

## 集中流动性

在 uniswap V3 中，一个交易对的整个价格曲线被拆分成多个价格区间，LP 可以选择他们想要提供流动性的价格区间，每个区间都有各自的流动性，每个区间的运作方式与 uniswap V2 完全相同，所以也可以说每个 V3 的交易对是由许多小型的 V2 交易对组成。这将允许 LP 把更多的流动性投入到活跃的价格区间内，大大提高资金利用率。

<img src="images/UniswapV3-02.jpg" alt="uniswapV3 流动性" width="50%" height="50%">

为了实现这种区间式的运作方式，Uniswap V3 引入了一个关键机制——虚拟流动性（Virtual Liquidity）。虚拟流动性不是 LP 实际存入的资产，而是用于参与价格计算和路径选择的数学流动性值。换句话说，系统在计算价格和滑点时，默认认为区间外仍存在潜在流动性，并据此构建交易模型。这种设计确保了在连续价格空间内，即便只激活部分区间，也能维持稳定的做市体验。

### 数学模型

为了更清晰地描述每个价格区间内的流动性行为，我们引入如下数学模型。图中展示了某一价格区间内的流动性曲线：

<img src="images/UniswapV3-01.jpg" alt="uniswapV3 集中流动性" width="30%" height="30%">

其中点 $P(x, y)$ 表示当前市场价格的状态，边界点 $Pa(x_a, y_a)$ 与 $Pb(x_b, y_b)$ 则定义了该区间的上下限。

由于 LP 的真实资产仅覆盖价格区间 $[P_a, P_b]$，但在恒定乘积公式 $x \cdot y = k$ 的计算中，我们需要一个完整的曲线覆盖整个区间，因此在计算中引入了虚拟流动性来补足区间边缘。这一机制允许模型持续满足恒定乘积关系，即：

$$
\begin{aligned}
x \cdot y = k\\
(x_v + x_r)(y_v + y_r) = k
\end{aligned}
$$

那么我们该怎么计算某个价格区间需要的虚拟流动性呢？这就需要 uniswapV2 中的公式：

$$
y = L \cdot \sqrt{p}\\
x = \frac{L}{\sqrt{p}}
$$

则有：

$$
(x_r + \frac{L}{\sqrt{p_a}})(y_r + L \cdot \sqrt{p_b}) = L^2
$$

该公式进一步揭示了 Uniswap V3 的核心机制：通过计算价格区间边界处的虚拟流动性值，构建区间内的资产交换模型，从而使每个价格区间都可以作为一个独立的 V2 池。这种结构性拆分不仅保留了恒定乘积做市原理，也实现了更高的资金利用率与策略灵活性。
