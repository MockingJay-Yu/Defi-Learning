# Uniswap V2

### Constant Product Automated Market Maker

AMM(自动化做市商)有许多不同的构建方法，unisawp 使用了**恒定乘积做市商**来构建。其核心数学原理只是一个非常简单的公式：

**$x * y = k$**

- x 和 y 代表了一个交易对中各自 token 的供应量。k 是他们的乘积。当用户进行交易时，将他们打算卖出的 token 放进池子，将他们打算购买的 token 移除池子，这会改变池子中两种 token 的数量。而恒定乘积做市商的原理就是：**在每次交易前后，k 保持不变**。

### AMM 的优点

- 在 AMM 中，价格发现是自动的。它由池中资产比例决定，无需像订单簿模型中需要等待合适的“出价”和“要价”，只有有流动性，它永远存在。但是这种现货价格并不是实际交易中的价格，实际交易中的价格往往会比较低。

- 在 AMM 中，只需要记录两个 token，并按照一定的规则转移它们，所以与需要大量簿记的订单簿相比，更加节省 gas。

### AMM 的缺点

- **价格总是变动，滑点频繁**
  在 AMM 中，价格发现是由池中资产比例决定的，所以每一笔交易都会影响价格。买入或卖出通常会遇到更多的滑点，受流动性深度，大额交易，价格波动，交易顺序等因素影响。攻击者可能会利用滑点发动三明治攻击。

- **LP 会遭受无常损失**
  无常损失在 AMM 中是不可避免的，在其他章节有对于无常损失的计算过程。

### Uniswap V2 的架构

Uniswap 遵循`core-periphery`的设计模式，最核心的逻辑位于 core 中，可选逻辑位于 periphery。这样做的目的是让 core 包含尽可能少的代码，减少核心业务逻辑中出现错误的可能性。用户可以选择通过 periphery 中的合约与 core 中的合约进行交互，也可以自己定制逻辑通过自己的合约直接与 core 中的合约交互。

# core

- **UniswapV2Factory**
  1. 负责创建 UniswapV2Pair，通过`create2`的方式创建。并在内部保存了所有 UniswapV2Pair 的地址。
  2. 保存了 feeTo 这个可以收取治理费用的地址，以及拥有设置并修改 feeTo 权限的 feeToSetter 地址。
- **UniswapV2Pair**
  1. 该合约持有两个 ERC20 代币的交易对，每个交易对都有一个 UniswapV2Pair 合约。如果所需的交易对不存在，则无需许可从 UniswapV2Factory 创建一个新的合约。
  2. 交易者可以交换，LP 可以为其提供流动性。UniswapV2Pair 合约本身也是 ERC20 代币，该代币为 LP Token，用于跟踪用户提供的流动性，类似于 ERC4626 的工作方式。

# periphery

提供了 2 个 router 合约，这些合约提供一些面向用户的机制，在 uniswap 的基本逻辑上做了增强，使得用户与 uniswap 交互更加安全。
